name: Build Windows Executable

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~\AppData\Local\pip\Cache
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: Create icon (optional)
      run: |
        python create_icon.py
      continue-on-error: true
    
    - name: Build Windows executable
      run: |
        python build_exe_windows.py
    
    - name: Test executable
      run: |
        if (Test-Path "dist\ExcelDataProcessor.exe") {
          Write-Host "âœ… Executable created successfully"
          $size = (Get-Item "dist\ExcelDataProcessor.exe").Length / 1MB
          Write-Host "ğŸ“Š File size: $([math]::Round($size, 1)) MB"
        } else {
          Write-Host "âŒ Executable not found"
          exit 1
        }
      shell: powershell
    
    - name: Create release package
      run: |
        # Create distribution directory
        New-Item -ItemType Directory -Force -Path "release"
        
        # Copy executable
        Copy-Item "dist\ExcelDataProcessor.exe" "release\"
        
        # Create README for release
        @"
# Excel Data Processor - Windowsç‰ˆæœ¬

## ğŸš€ å¿«é€Ÿå¼€å§‹
åŒå‡» ExcelDataProcessor.exe å³å¯å¯åŠ¨åº”ç”¨ç¨‹åºã€‚

## ğŸ“‹ åŠŸèƒ½ç‰¹æ€§
- âœ… æ”¯æŒExcel (.xlsx, .xls) å’ŒCSVæ–‡ä»¶å¯¼å…¥
- âœ… å­—æ®µé€‰æ‹©å’Œç®¡ç†
- âœ… è‡ªå®šä¹‰å­—æ®µæ·»åŠ 
- âœ… å®æ—¶æ•°æ®é¢„è§ˆ
- âœ… Excelæ–‡ä»¶è¾“å‡º
- âœ… ç°ä»£åŒ–GUIç•Œé¢

## ğŸ–¥ï¸ ç³»ç»Ÿè¦æ±‚
- Windows 7/8/10/11
- 2GB å†…å­˜ï¼ˆæ¨è4GBï¼‰
- 200MB ç£ç›˜ç©ºé—´

## ğŸ”§ æ•…éšœæ’é™¤
å¦‚æœé‡åˆ°å®‰å…¨è­¦å‘Šï¼Œè¯·ç‚¹å‡»"æ›´å¤šä¿¡æ¯" â†’ "ä»è¦è¿è¡Œ"

---
æ„å»ºæ—¥æœŸ: $(Get-Date -Format 'yyyyå¹´MMæœˆddæ—¥')
ç‰ˆæœ¬: 1.0.0
"@ | Out-File -FilePath "release\README.txt" -Encoding UTF8
        
        # Create version info
        @"
Build Information:
- Build Date: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')
- Python Version: $($PSVersionTable.PSVersion)
- Platform: Windows
- Architecture: x64
- Commit: $env:GITHUB_SHA
"@ | Out-File -FilePath "release\BUILD_INFO.txt" -Encoding UTF8
      shell: powershell
    
    - name: Upload executable artifact
      uses: actions/upload-artifact@v3
      with:
        name: ExcelDataProcessor-Windows-${{ github.sha }}
        path: release/
        retention-days: 30
    
    - name: Upload build logs
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: build-logs-${{ github.sha }}
        path: |
          build/
          *.log
        retention-days: 7

  # å¯é€‰ï¼šåˆ›å»ºRelease
  create-release:
    needs: build-windows
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
    - name: Download artifacts
      uses: actions/download-artifact@v3
      with:
        name: ExcelDataProcessor-Windows-${{ github.sha }}
        path: ./release
    
    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v1.0.${{ github.run_number }}
        release_name: Excel Data Processor v1.0.${{ github.run_number }}
        body: |
          ## Excel Data Processor Windowsç‰ˆæœ¬
          
          ### ğŸ“¦ ä¸‹è½½
          - [ExcelDataProcessor.exe](./ExcelDataProcessor.exe) - Windowså¯æ‰§è¡Œæ–‡ä»¶
          
          ### ğŸš€ ä½¿ç”¨æ–¹æ³•
          1. ä¸‹è½½ ExcelDataProcessor.exe
          2. åŒå‡»è¿è¡Œï¼ˆå¯èƒ½éœ€è¦å…è®¸å®‰å…¨è­¦å‘Šï¼‰
          3. å¼€å§‹å¤„ç†Excelæ•°æ®
          
          ### ğŸ“‹ åŠŸèƒ½ç‰¹æ€§
          - âœ… Excel/CSVæ–‡ä»¶å¯¼å…¥
          - âœ… å­—æ®µé€‰æ‹©å’Œè‡ªå®šä¹‰
          - âœ… æ•°æ®é¢„è§ˆ
          - âœ… æ–‡ä»¶è¾“å‡º
          
          ### ğŸ–¥ï¸ ç³»ç»Ÿè¦æ±‚
          - Windows 7/8/10/11
          - 2GB+ å†…å­˜
          - 200MB+ ç£ç›˜ç©ºé—´
          
          ---
          æ„å»ºæ—¶é—´: ${{ github.event.head_commit.timestamp }}
          æäº¤: ${{ github.sha }}
        draft: false
        prerelease: false
    
    - name: Upload Release Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./release/ExcelDataProcessor.exe
        asset_name: ExcelDataProcessor.exe
        asset_content_type: application/octet-stream