name: Build Windows Executable

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: List project files
      run: |
        echo "Project structure:"
        dir /s
      shell: cmd
    
    - name: Create icon (optional)
      run: |
        python create_icon.py
      continue-on-error: true
    
    - name: Build Windows executable
      run: |
        python build_exe_windows.py
    
    - name: Test executable
      run: |
        if (Test-Path "dist\ExcelDataProcessor.exe") {
          Write-Host "âœ… Executable created successfully"
          $size = (Get-Item "dist\ExcelDataProcessor.exe").Length / 1MB
          Write-Host "ğŸ“Š File size: $([math]::Round($size, 1)) MB"
        } else {
          Write-Host "âŒ Executable not found"
          Write-Host "Contents of dist directory:"
          if (Test-Path "dist") {
            Get-ChildItem "dist" -Recurse
          } else {
            Write-Host "dist directory does not exist"
          }
          exit 1
        }
      shell: powershell
    
    - name: Create release package
      run: |
        # Create distribution directory
        New-Item -ItemType Directory -Force -Path "release"
        
        # Copy executable
        Copy-Item "dist\ExcelDataProcessor.exe" "release\"
        
        # Create README for release
        @"
# Excel Data Processor - Windowsç‰ˆæœ¬

## ğŸš€ å¿«é€Ÿå¼€å§‹
åŒå‡» ExcelDataProcessor.exe å³å¯å¯åŠ¨åº”ç”¨ç¨‹åºã€‚

## ğŸ“‹ åŠŸèƒ½ç‰¹æ€§
- âœ… æ”¯æŒExcel (.xlsx, .xls) å’ŒCSVæ–‡ä»¶å¯¼å…¥
- âœ… å­—æ®µé€‰æ‹©å’Œç®¡ç†
- âœ… è‡ªå®šä¹‰å­—æ®µæ·»åŠ 
- âœ… å®æ—¶æ•°æ®é¢„è§ˆ
- âœ… Excelæ–‡ä»¶è¾“å‡º
- âœ… ç°ä»£åŒ–GUIç•Œé¢

## ğŸ–¥ï¸ ç³»ç»Ÿè¦æ±‚
- Windows 7/8/10/11
- 2GB å†…å­˜ï¼ˆæ¨è4GBï¼‰
- 200MB ç£ç›˜ç©ºé—´

## ğŸ”§ æ•…éšœæ’é™¤
å¦‚æœé‡åˆ°å®‰å…¨è­¦å‘Šï¼Œè¯·ç‚¹å‡»"æ›´å¤šä¿¡æ¯" â†’ "ä»è¦è¿è¡Œ"

---
æ„å»ºæ—¥æœŸ: $(Get-Date -Format 'yyyyå¹´MMæœˆddæ—¥')
ç‰ˆæœ¬: 1.0.0
"@ | Out-File -FilePath "release\README.txt" -Encoding UTF8
        
        # Create version info
        @"
Build Information:
- Build Date: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')
- Python Version: $($PSVersionTable.PSVersion)
- Platform: Windows
- Architecture: x64
- Commit: $env:GITHUB_SHA
"@ | Out-File -FilePath "release\BUILD_INFO.txt" -Encoding UTF8
      shell: powershell
    
    - name: Upload executable artifact
      uses: actions/upload-artifact@v3
      with:
        name: ExcelDataProcessor-Windows-${{ github.sha }}
        path: release/
        retention-days: 30
    
    - name: Upload build logs
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: build-logs-${{ github.sha }}
        path: |
          build/
          *.log
        retention-days: 7